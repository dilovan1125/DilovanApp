<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ูุธุงู ูุญุงุณุจุฉ ุงููุชุฌุฑ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
</head>
<body class="bg-gray-100 text-gray-900">

<nav class="bg-blue-600 text-white flex justify-around p-4">
  <button onclick="showPage('sales')" class="font-bold">๐ฐ ุงููุจูุนุงุช</button>
  <button onclick="showPage('products')" class="font-bold">๐ฆ ุงูููุชุฌุงุช</button>
  <button onclick="showPage('log')" class="font-bold">๐ ุงูุณุฌู</button>
  <button onclick="showPage('profit')" class="font-bold">๐ ุงูุฑุจุญ</button>
</nav>

<div id="pages" class="p-4">

  <!-- ุตูุญุฉ ุงููุจูุนุงุช -->
  <section id="sales" class="page hidden">
    <h2 class="text-xl font-bold mb-4">ุตูุญุฉ ุงููุจูุนุงุช</h2>
    <button onclick="startScanner('sale')" class="bg-green-600 text-white px-4 py-2 rounded">๐ท ูุณุญ ุจุงุฑููุฏ</button>
    <div id="sale-result" class="mt-4"></div>
    <video id="video-sale" class="mt-4 w-full max-w-sm"></video>
    <div class="mt-4">
      <input id="sale-qty" type="number" placeholder="ุงููููุฉ" class="border p-2">
      <input id="sale-price" type="number" placeholder="ุณุนุฑ ุงูุจูุน" class="border p-2">
      <button onclick="addSale()" class="bg-blue-600 text-white px-4 py-2 rounded">ุฅุถุงูุฉ ุนูููุฉ ุจูุน</button>
    </div>
  </section>

  <!-- ุตูุญุฉ ุงูููุชุฌุงุช -->
  <section id="products" class="page hidden">
    <h2 class="text-xl font-bold mb-4">ุตูุญุฉ ุงูููุชุฌุงุช</h2>
    <button onclick="startScanner('product')" class="bg-green-600 text-white px-4 py-2 rounded">๐ท ูุณุญ ุจุงุฑููุฏ</button>
    <div id="product-result" class="mt-4"></div>
    <video id="video-product" class="mt-4 w-full max-w-sm"></video>
    <div class="mt-4">
      <input id="prod-code" type="text" placeholder="ุจุงุฑููุฏ" class="border p-2">
      <input id="prod-name" type="text" placeholder="ุงุณู ุงูููุชุฌ" class="border p-2">
      <input id="prod-cost" type="number" placeholder="ุณุนุฑ ุงูุชูููุฉ" class="border p-2">
      <input id="prod-price" type="number" placeholder="ุณุนุฑ ุงูุจูุน" class="border p-2">
      <input id="prod-qty" type="number" placeholder="ุงููููุฉ" class="border p-2">
      <button onclick="addProduct()" class="bg-blue-600 text-white px-4 py-2 rounded">ุฅุถุงูุฉ ููุชุฌ</button>
    </div>
    <h3 class="mt-4 font-bold">ูุงุฆูุฉ ุงูููุชุฌุงุช</h3>
    <table id="products-table" class="table-auto w-full border mt-2 bg-white"></table>
    <div class="mt-4 font-bold">ุฅุฌูุงูู ูููุฉ ุงููุฎุฒูู: <span id="total-stock"></span></div>
  </section>

  <!-- ุตูุญุฉ ุงูุณุฌู -->
  <section id="log" class="page hidden">
    <h2 class="text-xl font-bold mb-4">ุณุฌู ุงููุจูุนุงุช</h2>
    <table id="log-table" class="table-auto w-full border mt-2 bg-white"></table>
  </section>

  <!-- ุตูุญุฉ ุงูุฑุจุญ -->
  <section id="profit" class="page hidden">
    <h2 class="text-xl font-bold mb-4">ุตุงูู ุงูุฑุจุญ</h2>
    <div class="font-bold text-2xl text-green-700" id="profit-total">0</div>
  </section>

</div>

<script>
function showPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
showPage('sales');

//------------------ IndexedDB ------------------//
let db;
const request = indexedDB.open("StoreDB", 1);

request.onupgradeneeded = function(e) {
  db = e.target.result;
  if (!db.objectStoreNames.contains("products")) {
    db.createObjectStore("products", { keyPath: "code" });
  }
  if (!db.objectStoreNames.contains("sales")) {
    db.createObjectStore("sales", { autoIncrement: true });
  }
};

request.onsuccess = function(e) {
  db = e.target.result;
  renderTables();
};
request.onerror = e => console.error("DB error", e);

// ุฅุถุงูุฉ ููุชุฌ
function addProduct(){
  const tx = db.transaction("products","readwrite");
  const store = tx.objectStore("products");
  store.put({
    code: document.getElementById('prod-code').value || scannedCode || 'ูุฏูู',
    name: document.getElementById('prod-name').value,
    cost: parseFloat(document.getElementById('prod-cost').value),
    price: parseFloat(document.getElementById('prod-price').value),
    qty: parseInt(document.getElementById('prod-qty').value)
  });
  tx.oncomplete = ()=> renderTables();
}

// ุฅุถุงูุฉ ุนูููุฉ ุจูุน
function addSale(){
  const code = scannedCode || document.getElementById('prod-code').value;
  const qty = parseInt(document.getElementById('sale-qty').value);
  const price = parseFloat(document.getElementById('sale-price').value);

  const tx = db.transaction(["products","sales"],"readwrite");
  const pStore = tx.objectStore("products");
  const sStore = tx.objectStore("sales");

  const req = pStore.get(code);
  req.onsuccess = ()=>{
    const prod = req.result;
    if(prod){
      prod.qty -= qty;
      pStore.put(prod);
      sStore.add({
        code,
        qty,
        price,
        cost: prod.cost,
        date: new Date().toLocaleString()
      });
    }
  };
  tx.oncomplete = ()=> renderTables();
}

// ุนุฑุถ ุงูุฌุฏุงูู
function renderTables(){
  // ููุชุฌุงุช
  const pTx = db.transaction("products","readonly");
  const pStore = pTx.objectStore("products");
  const pReq = pStore.getAll();
  pReq.onsuccess = ()=>{
    const products = pReq.result;
    let pt = '<tr><th>ุจุงุฑููุฏ</th><th>ุงุณู</th><th>ุชูููุฉ</th><th>ุจูุน</th><th>ูููุฉ</th></tr>';
    let total=0;
    products.forEach(p=>{
      pt+=`<tr><td>${p.code}</td><td>${p.name}</td><td>${p.cost}</td><td>${p.price}</td><td>${p.qty}</td></tr>`;
      total += p.cost * p.qty;
    });
    document.getElementById('products-table').innerHTML=pt;
    document.getElementById('total-stock').textContent= total;

    // ุณุฌู
    const sTx = db.transaction("sales","readonly");
    const sStore = sTx.objectStore("sales");
    const sReq = sStore.getAll();
    sReq.onsuccess = ()=>{
      const sales = sReq.result;
      let lt = '<tr><th>ุชุงุฑูุฎ</th><th>ุจุงุฑููุฏ</th><th>ูููุฉ</th><th>ุณุนุฑ ุงูุจูุน</th><th>ุณุนุฑ ุงูุชูููุฉ</th><th>ุฑุจุญ</th></tr>';
      let profit=0;
      sales.forEach(s=>{
        let p = (s.price - s.cost) * s.qty;
        profit+=p;
        lt+=`<tr><td>${s.date}</td><td>${s.code}</td><td>${s.qty}</td><td>${s.price}</td><td>${s.cost}</td><td>${p}</td></tr>`;
      });
      document.getElementById('log-table').innerHTML=lt;
      document.getElementById('profit-total').textContent = profit;
    };
  };
}

// ูุงุณุญ ุจุงุฑููุฏ
let scannedCode = null;
function startScanner(type){
  scannedCode=null;
  const codeReader = new ZXing.BrowserMultiFormatReader();
  const videoId = type==='sale' ? 'video-sale' : 'video-product';
  codeReader.decodeFromVideoDevice(null, videoId, (result,err)=>{
    if(result){
      scannedCode = result.text;
      if(type==='sale')
        document.getElementById('sale-result').textContent = 'ุชู ูุฑุงุกุฉ: '+scannedCode;
      else
        document.getElementById('product-result').textContent = 'ุชู ูุฑุงุกุฉ: '+scannedCode;
      codeReader.reset();
    }
  });
}
</script>
</body>
</html>
